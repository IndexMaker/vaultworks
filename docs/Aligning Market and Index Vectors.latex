\documentclass[11pt, a4paper]{article}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{amsthm}
\usepackage{booktabs}
\usepackage[a4paper, top=2.5cm, bottom=2.5cm, left=2.5cm, right=2.5cm]{geometry}
\usepackage{hyperref}
\hypersetup{
    colorlinks=true,
    linkcolor=blue,
    filecolor=magenta,      
    urlcolor=cyan,
}
\usepackage{enumitem}

\title{Aligning Market and Index Vectors\\[10pt]
\large An implementation of the vector virtual machine for financial applications
}
\author{Sonia Kolasinska}
\date{\today}

\begin{document}

\maketitle
\begin{abstract}
This document summarizes several implementation strategies for core vector alignment within the WebAssembly (WASM) execution environment. The objective was to select an algorithm that ensures stable, predictable transaction costs while efficiently handling the atomic \textbf{Join-Filter (JFLT)}, \textbf{Join-Update (JUPD)}, and \textbf{Join-Add (JADD)} operations. This review incorporates all empirical gas data, including a new finding that confirms the unpredictable and excessive cost of the riskiest solution on mixed data. This report validates the selection of the \textbf{Hybrid Linear/Logarithmic Solution (d)}, which provides optimal flexibility and cost control across various data scenarios.
\end{abstract}

\section{Problem: Vector Alignment for Market Delta Calculation}
The primary requirement is to synchronize two sorted vectors: a larger Market State Vector ($\mathbf{M}$) and a smaller Index Order Vector ($\mathbf{N}$). The process involves performing \textbf{Join-Add (JADD), Join-Update (JUPD), and Join-Filter (JFLT)} operations to generate the market size delta.

Specifically:
\begin{enumerate}
    \item \textbf{Join-Filter:} Project elements from $\mathbf{M}$ onto $\mathbf{N}$.
    \item \textbf{Join-Update:} Replace selected elements in $\mathbf{M}$ with values from corresponding data in $\mathbf{N}$.
    \item \textbf{Join-Add:} Add to selected elements in $\mathbf{M}$ the values from corresponding data in $\mathbf{N}$.
\end{enumerate}

Due to the nature of dynamic array operations in WASM, in-place removal of elements from the beginning of the large vector $\mathbf{M}$ can lead to excessive data shifting, introducing non-deterministic execution costs.

\section{Solutions Proposed}
Four primary implementation strategies were considered and tested to validate their theoretical complexity against practical WASM gas cost. The size of the market vector is $\mathbf{M}$ and the size of the user vector is $\mathbf{N}$.

\begin{table}[htbp]
    \centering
    \small % Reduce font size for table
    \caption{Overview of Proposed Vector Alignment Solutions}
    \label{tab:solutions}
    % Using p{width} columns to allow wrapping and control table width
    \setlength{\arraycolsep}{6pt} % Adjust horizontal space
    \renewcommand{\arraystretch}{1.4} % Increased vertical spacing between rows for better readability
    \begin{tabular}{@{}l p{3.5cm} l p{3.5cm} p{3.5cm}@{}}
        \toprule
        Version & Implementation Method & Theoretical Complexity & Core Mechanism & Risk Note \\
        \midrule
        \textbf{(a)} & Linear Scan with In-Place Filtering & $O(N+M) \rightarrow \mathbf{O(M^2)}$ & In-place mutation (removal) & Risk of cost spike due to array shifting. \\
        \textbf{(b)} & Linear Scan with Append to a New Vector & $\mathbf{O(N+M)}$ & Linear read, selective copy to new vector. & Safe and highly efficient on simple data. \\
        \textbf{(c)} & Pure Binary Search and Append & $O(N \cdot \log M)$ & Binary search for every element in $\mathbf{N}$. & Safe, but higher inherent search overhead. \\
        \textbf{(d)} & \textbf{Hybrid Linear/Logarithmic} & $\mathbf{O(N + J \cdot \log M)}$ & Linear scan for contiguous blocks, binary search jump ($J$) for gaps. & Optimal flexibility and cost management. \\
        \bottomrule
    \end{tabular}
\end{table}

\section{Measurements: Simple Test Observations}
Initial testing utilized a simple, low-rigor contiguous dataset (Test Set A) to establish baseline costs. This was followed by a more relevant test case (Test Set B) featuring a mix of sparse and contiguous data, representative of real market orders. The tests used a fixed dataset size: \textbf{50 asset index ($\mathbf{N}$) and 150 asset market ($\mathbf{M}$)}.

\begin{table}[htbp]
    \centering
    \small % Reduce font size for table
    \caption{Comparative Empirical Gas Costs (Test Sets A and B)}
    \label{tab:measurements}
    % Using p{width} columns for headers that need wrapping
    \setlength{\arraycolsep}{6pt} % Adjust horizontal space
    \renewcommand{\arraystretch}{1.2} % Set vertical spacing to 1.2 for this table as well
    \begin{tabular}{@{}l l r r@{}}
        \toprule
        Version & Implementation Method & Gas Cost (Test Set A) & Gas Cost (Test Set B - Mixed Data) \\
        \midrule
        \textbf{(a)} & Linear scan, filtering \textbf{in-place} & $3,380,000$ & $\mathbf{3,993,165}$ \\
        \textbf{(b)} & Linear scan, filtering and \textbf{appending} & $\mathbf{3,380,000}$ & $3,990,747$ \\
        \textbf{(c)} & Pure Binary Search and Append & $3,970,000$ & $3,991,967$ \\
        \textbf{(d)} & \textbf{Hybrid Linear/Logarithmic} & $3,420,000$ & $\mathbf{3,990,453}$ \\
        \bottomrule
    \end{tabular}
\end{table}
\textit{Test Set B utilized asset labels with multiple contiguous sections and sparse sections (e.g., $1, 2, 5, 9$ followed by a block $31..41$). The cost observed for Solution (a) in Test Set B ($3,993,165$) was the highest measured across all efficient solutions, validating the risk associated with its $O(M^2)$ worst-case complexity.}

\section{Conclusions}
The Test Set B confirmed that Solution (a)'s inherent risk of $\mathbf{O(M^2)}$ cost spikes makes it unacceptable. Solutions (b), (c), and (d) all offer deterministic safety.

The critical findings from the mixed-data Test Set B are the empirical validation of both the risk and the theoretical choice:

\begin{enumerate}
    \item \textbf{Deterministic Safety:} All final candidates are safe.
    \item \textbf{Risk Validation:} Solution (a) incurred the highest gas cost ($3,993,165$) under mixed-data conditions, proving its cost is volatile and unacceptable.
    \item \textbf{Comparative Efficiency:} The three deterministic solutions performed closely: Solution (d) at $3,990,453$ gas, Solution (b) at $3,990,747$ gas, and Solution (c) at $3,991,967$ gas. This confirms that the hybrid approach (\textbf{d}) is the most gas-efficient under these mixed-data conditions, validating the strategic decision to prioritize its adaptive logic.
\end{enumerate}

\textbf{Mandate:} The \textbf{Hybrid Solution (d)} is selected for implementation. It offers the required deterministic safety and has been empirically proven to be the most gas-efficient solution for handling the varied, complex data distributions of the market vectors.

\end{document}